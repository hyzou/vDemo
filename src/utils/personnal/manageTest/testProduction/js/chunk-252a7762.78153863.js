(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-252a7762"],{"02f4":function(t,e,o){var n=o("4588"),s=o("be13");t.exports=function(t){return function(e,o){var r,a,i=String(s(e)),l=n(o),c=i.length;return l<0||l>=c?t?"":void 0:(r=i.charCodeAt(l),r<55296||r>56319||l+1===c||(a=i.charCodeAt(l+1))<56320||a>57343?t?i.charAt(l):r:t?i.slice(l,l+2):a-56320+(r-55296<<10)+65536)}}},"0390":function(t,e,o){"use strict";var n=o("02f4")(!0);t.exports=function(t,e,o){return e+(o?n(t,e).length:1)}},"0bfb":function(t,e,o){"use strict";var n=o("cb7c");t.exports=function(){var t=n(this),e="";return t.global&&(e+="g"),t.ignoreCase&&(e+="i"),t.multiline&&(e+="m"),t.unicode&&(e+="u"),t.sticky&&(e+="y"),e}},"214f":function(t,e,o){"use strict";o("b0c5");var n=o("2aba"),s=o("32e9"),r=o("79e5"),a=o("be13"),i=o("2b4c"),l=o("520a"),c=i("species"),u=!r(function(){var t=/./;return t.exec=function(){var t=[];return t.groups={a:"7"},t},"7"!=="".replace(t,"$<a>")}),p=function(){var t=/(?:)/,e=t.exec;t.exec=function(){return e.apply(this,arguments)};var o="ab".split(t);return 2===o.length&&"a"===o[0]&&"b"===o[1]}();t.exports=function(t,e,o){var f=i(t),d=!r(function(){var e={};return e[f]=function(){return 7},7!=""[t](e)}),h=d?!r(function(){var e=!1,o=/a/;return o.exec=function(){return e=!0,null},"split"===t&&(o.constructor={},o.constructor[c]=function(){return o}),o[f](""),!e}):void 0;if(!d||!h||"replace"===t&&!u||"split"===t&&!p){var v=/./[f],g=o(a,f,""[t],function(t,e,o,n,s){return e.exec===l?d&&!s?{done:!0,value:v.call(e,o,n)}:{done:!0,value:t.call(o,e,n)}:{done:!1}}),m=g[0],y=g[1];n(String.prototype,t,m),s(RegExp.prototype,f,2==e?function(t,e){return y.call(t,this,e)}:function(t){return y.call(t,this)})}}},"28a5":function(t,e,o){"use strict";var n=o("aae3"),s=o("cb7c"),r=o("ebd6"),a=o("0390"),i=o("9def"),l=o("5f1b"),c=o("520a"),u=o("79e5"),p=Math.min,f=[].push,d="split",h="length",v="lastIndex",g=4294967295,m=!u(function(){RegExp(g,"y")});o("214f")("split",2,function(t,e,o,u){var y;return y="c"=="abbc"[d](/(b)*/)[1]||4!="test"[d](/(?:)/,-1)[h]||2!="ab"[d](/(?:ab)*/)[h]||4!="."[d](/(.?)(.?)/)[h]||"."[d](/()()/)[h]>1||""[d](/.?/)[h]?function(t,e){var s=String(this);if(void 0===t&&0===e)return[];if(!n(t))return o.call(s,t,e);var r,a,i,l=[],u=(t.ignoreCase?"i":"")+(t.multiline?"m":"")+(t.unicode?"u":"")+(t.sticky?"y":""),p=0,d=void 0===e?g:e>>>0,m=new RegExp(t.source,u+"g");while(r=c.call(m,s)){if(a=m[v],a>p&&(l.push(s.slice(p,r.index)),r[h]>1&&r.index<s[h]&&f.apply(l,r.slice(1)),i=r[0][h],p=a,l[h]>=d))break;m[v]===r.index&&m[v]++}return p===s[h]?!i&&m.test("")||l.push(""):l.push(s.slice(p)),l[h]>d?l.slice(0,d):l}:"0"[d](void 0,0)[h]?function(t,e){return void 0===t&&0===e?[]:o.call(this,t,e)}:o,[function(o,n){var s=t(this),r=void 0==o?void 0:o[e];return void 0!==r?r.call(o,s,n):y.call(String(s),o,n)},function(t,e){var n=u(y,t,this,e,y!==o);if(n.done)return n.value;var c=s(t),f=String(this),d=r(c,RegExp),h=c.unicode,v=(c.ignoreCase?"i":"")+(c.multiline?"m":"")+(c.unicode?"u":"")+(m?"y":"g"),I=new d(m?c:"^(?:"+c.source+")",v),b=void 0===e?g:e>>>0;if(0===b)return[];if(0===f.length)return null===l(I,f)?[f]:[];var C=0,w=0,D=[];while(w<f.length){I.lastIndex=m?w:0;var S,x=l(I,m?f:f.slice(w));if(null===x||(S=p(i(I.lastIndex+(m?0:w)),f.length))===C)w=a(f,w,h);else{if(D.push(f.slice(C,w)),D.length===b)return D;for(var $=1;$<=x.length-1;$++)if(D.push(x[$]),D.length===b)return D;w=C=S}}return D.push(f.slice(C)),D}]})},"520a":function(t,e,o){"use strict";var n=o("0bfb"),s=RegExp.prototype.exec,r=String.prototype.replace,a=s,i="lastIndex",l=function(){var t=/a/,e=/b*/g;return s.call(t,"a"),s.call(e,"a"),0!==t[i]||0!==e[i]}(),c=void 0!==/()??/.exec("")[1],u=l||c;u&&(a=function(t){var e,o,a,u,p=this;return c&&(o=new RegExp("^"+p.source+"$(?!\\s)",n.call(p))),l&&(e=p[i]),a=s.call(p,t),l&&a&&(p[i]=p.global?a.index+a[0].length:e),c&&a&&a.length>1&&r.call(a[0],o,function(){for(u=1;u<arguments.length-2;u++)void 0===arguments[u]&&(a[u]=void 0)}),a}),t.exports=a},"5f1b":function(t,e,o){"use strict";var n=o("23c6"),s=RegExp.prototype.exec;t.exports=function(t,e){var o=t.exec;if("function"===typeof o){var r=o.call(t,e);if("object"!==typeof r)throw new TypeError("RegExp exec method returned something other than an Object or null");return r}if("RegExp"!==n(t))throw new TypeError("RegExp#exec called on incompatible receiver");return s.call(t,e)}},"67ef":function(t,e,o){"use strict";o.r(e);o("28a5"),o("7f7f");var n=o("f852"),s={name:"preTestEqp",components:{myheader:function(){return o.e("chunk-60639bfc").then(o.bind(null,"8c2e"))}},data:function(){return{stompClient:null,subscribeArray:[],headerOptionSettings:{hideleft:!1,title:"tank"==this.$route.query.controlType?"柜控测试":"程控测试",routePath:"selectTest"},statusvalue:[],controlvalue:[],statusItems:[],controlItems:[],formdata:{eqpName:"",stateRegisterIp:"",controlRegisterIp:""},testStepId:this.$route.query.testProcessStepId,stepTestInfo:this.$store.getters.chosedProcess,gatewayInfo:{},controllerInfo:{},propertyVars:[],showLoadingDiv:!1,controllerId:this.$route.query.eqpId?this.$route.query.eqpId:"",countDownNumber:120,countDownProject:null,getDefaultCountDownNumber:10,getDefaultCountDownProject:null,connectControllerParams:{},testResultArray:[],connectedController:!1}},methods:{handleOperateEqp:function(t){var e="";this.controlItems.map(function(o){o.key==t&&(e=o.value)}),this.getSetProperty(e)},handleStep:function(t){var e=this;if("nextStep"==t.instruction||"getResult"==t.instruction)if(t.status&&"start"==t.status)this.showLoadingDiv=!0,this.dealGetDefaultCountDown(),this.getConnectController(this.connectControllerParams);else{var o={};this.getProperty().then(function(n){var s=[],r=[];e.statusItems.map(function(t,o){s.push(t.value),t.getSocketVal=e.statusvalue[o]||0===e.statusvalue[o]?e.statusvalue[o]+"":""}),e.controlItems.map(function(t,o){r.push(t.value),t.getSocketVal=e.controlvalue[o]||0===e.controlvalue[o]?e.controlvalue[o]+"":""}),o.statusR=e.statusItems,o.controlR=e.controlItems,o.processName=e.stepTestInfo.process[e.testStepId].tipsTitle,e.testResultArray.push(o),JSON.stringify(s)==JSON.stringify(e.statusvalue)&&JSON.stringify(r)==JSON.stringify(e.controlvalue)&&n.data[0].value==s[s.length-1]?"getResult"==t.instruction?(e.$store.dispatch("setPlcTestResult","true_"+e.stepTestInfo.process[e.testStepId].tipsTitle),e.getCloseController()):(e.statusvalue=[],e.controlvalue=[],e.getProperty().then(function(t){e.testStepId=parseInt(e.testStepId)+1,e.statusvalue.push(t.data[0].value)})):e.$messagebox({title:"提示",message:"预设值与分机返回值不符，本次测试失败",showCancelButton:!1,confirmButtonText:"查看测试结果"}).then(function(){e.$store.dispatch("setPlcTestResult","false_"+e.stepTestInfo.process[e.testStepId].tipsTitle),e.getCloseController()})})}if("stopTest"==t.instruction){var n=this.$route.query;delete n.testProcessId,this.getCloseController(n),this.testStepId==this.$route.query.testProcessStepId&&this.$router.push({path:"selectTest",query:n})}},getDeviceConfig:function(t){var e=this;e.$postData(e.$api.getDeviceConfig,{deviceId:t}).then(function(t){t&&t.data&&(e.formdata=JSON.parse(t.data.testDeviceDto.deviceParameter),e.getControllerConfig(t.data.testDeviceDto.controllerId,t.data.testDeviceDto.storePointId))})},getControllerConfig:function(t,e){var o=this;this.$postData(this.$api.getControllerConfig,{controllerId:t,storePointId:e}).then(function(t){o.controllerId=t.data.controllerId,o.controllerInfo=t.data.testControllerDto,o.getStoreGateWayInfo()})},getStoreGateWayInfo:function(){var t=this;this.$getData(this.$api.getStoreGateWayInfo,{storepointId:this.controllerInfo.storePointId}).then(function(e){if(0!=e.data.length){var o=e.data.filter(function(t){if(!t.storehouseId)return!0});0!=o.length?(t.controllerInfo.gatewayInfo=o[0],t.gatewayInfo=o[0],t.connectControllerParams=t.controllerInfo,t.getSocketConnect()):t.$messagebox.alert("该库区未检测到可用的网关配置").then(function(){var e=t.$route.query;delete e.testProcessId,t.getCloseController(e)})}else t.$messagebox.alert("该库区未检测到网关配置").then(function(){var e=t.$route.query;delete e.testProcessId,t.getCloseController(e)})})},getConnectController:function(t){var e=this;this.showLoadingDiv=!0;var o="",n="",s="";o="tcp"==t.connectionType?t.protocolType+"://"+t.host+":"+t.port:"jhrtu://"+t.host+":"+t.port,n="s7"==t.protocolType?"SMART_V":"modbus"==t.protocolType?"HOLDING_REGISTER":"HostLinkSector",this.$store.getters.eqpTpyeDatas.map(function(t){t.value==e.formdata.eqpTpye&&(s=t.alias)}),this.propertyVars=[{offset:this.formdata.statusRegister,sectorName:n,vid:s+"_state01",vtypeName:"uint16"},{offset:this.formdata.controlRegister,sectorName:n,vid:s+"_control01",vtypeName:"uint16"}],this.formdata.sysmode&&this.propertyVars.push({offset:this.formdata.sysmode,sectorName:n,vid:"sysmode_state",vtypeName:"uint16"},{offset:this.formdata.sysmode,sectorName:n,vid:"sysmode_control",vtypeName:"uint16"});var r={ctrDto:{ctrlId:this.controllerId,chUrl:o,vars:this.propertyVars,compactibilities:t.protocolParameter},gwDto:{id:t.gatewayInfo.hwSysId,name:t.gatewayInfo.name}};this.$postData(this.$api.connectController+"?t="+(new Date).getTime(),r,!0).then(function(t){t&&t.data?(e.connectedController=!0,setTimeout(function(){e.showLoadingDiv=!1},1e4)):(e.showLoadingDiv=!1,clearInterval(e.getDefaultCountDownProject),e.$messagebox.alert("控制器建立失败"))})},getSetProperty:function(t,e){var o=this;this.showLoadingDiv=!0;var n="";e?n="sysmode_control":this.$store.getters.eqpTpyeDatas.map(function(t){t.value==o.formdata.eqpTpye&&(n=t.alias+"_control01")}),this.$postData(this.$api.setProperty,{ctrlId:this.$route.query.eqpId,gatewayId:this.gatewayInfo.hwSysId,vars:[{vid:n,value:t}]},!0).then(function(t){t&&t.data&&setTimeout(function(){o.showLoadingDiv=!1},5e3)})},getProperty:function(t){var e=this;return new Promise(function(o){var n="";t?n="sysmode_state":e.$store.getters.eqpTpyeDatas.map(function(t){t.value==e.formdata.eqpTpye&&(n=t.alias+"_state01")}),e.$postData(e.$api.getProperty,{ctrlId:e.$route.query.eqpId,gatewayId:e.gatewayInfo.hwSysId,vids:[n]},!0).then(function(t){o(t)})})},getCloseController:function(t){var e=this;this.connectedController&&this.$postData(this.$api.closeController,{ctrlId:this.$route.query.eqpId,gatewayId:this.gatewayInfo.hwSysId}).then(function(){e.connectedController=!1}),t?this.$router.push({path:"selectTest",query:t}):(this.$store.dispatch("setPlcTestErrorInfo",this.testResultArray),this.$router.push({path:"testResult",query:this.$route.query}))},getSocketConnect:function(){var t=this,e=this;n["default"].socketConnect({url:e.$api.socketMain,username:"crk",callback:function(o){e.stompClient=o;var s=n["default"].openSubscribe({url:"/_topic/test/connectController/"+t.gatewayInfo.hwSysId+"/"+e.controllerId,stompClient:e.stompClient,callback:function(t){e.dealSubscribeResponse(t.body)}}),r=n["default"].openSubscribe({url:"/_topic/test/Controller/"+t.gatewayInfo.hwSysId+"/"+e.controllerId,stompClient:e.stompClient,callback:function(t){e.dealSubscribeResponseStates(t.body)}});e.subscribeArray.push(r),e.subscribeArray.push(s)}})},dealSubscribeResponse:function(t){var e=this,o=JSON.parse(t);if("连接失败"==o.msg)this.showLoadingDiv=!1,clearInterval(this.getDefaultCountDownProject),this.$messagebox.alert("分机连接失败，请知晓");else if("连接成功"==o.data)var n=0,s=setInterval(function(){n++,n<=5?e.getProperty().then(function(t){t.data.length>0&&(clearInterval(s),e.showLoadingDiv=!1,clearInterval(e.getDefaultCountDownProject),e.formdata.close==t.data[0].value||e.formdata.stop==t.data[0].value?e.testStepId=parseInt(e.testStepId)+1:e.$messagebox({title:"提示",message:"分机初始状态不是出于关闭状态，请使用柜控关闭设备后重试",showCancelButton:!1,confirmButtonText:"确定"}).then(function(){var t=e.$route.query;delete t.testProcessId,e.getCloseController(t),e.$router.push({path:"selectTest",query:t})}))}):(e.showLoadingDiv=!1,clearInterval(e.getDefaultCountDownProject),clearInterval(s),e.$messagebox.alert("获取分机初始状态连接超时"))},1e3)},dealSubscribeResponseStates:function(t){var e=this,o=JSON.parse(t);o.map(function(t){t.oldVal=t.oldVal+""||"",t.newVal=t.newVal+"","state01"==t.vid.split("_")[t.vid.split("_").length-1]&&e.statusvalue.push(t.newVal),"control01"==t.vid.split("_")[t.vid.split("_").length-1]&&t.oldVal&&"undefined"!=t.oldVal&&e.controlvalue.push(t.newVal)})},dealCountDown:function(){var t=this;this.countDownProject=setInterval(function(){t.countDownNumber--,1==t.countDownNumber&&(t.$messagebox({title:"提示",message:"当前测试流程长时间未操作，请选择您要进行的操作",showCancelButton:!0,confirmButtonText:"下一步",cancelButtonText:"结束测试"}).then(function(e){"confirm"===e?t.handleStep(t.stepTestInfo.process[t.testStepId].stepButtons[1]):t.handleStep(t.stepTestInfo.process[t.testStepId].stepButtons[0])}),clearInterval(t.countDownProject))},1e3)},dealGetDefaultCountDown:function(){var t=this;this.getDefaultCountDownProject=setInterval(function(){t.getDefaultCountDownNumber--,1==t.getDefaultCountDownNumber&&(t.showLoadingDiv=!1,clearInterval(t.getDefaultCountDownProject),t.$messagebox.alert("未检测到设备是否处于关闭状态，请检查信息是否出错"))},1e3)}},mounted:function(){this.$route.query.testEqpId&&this.getDeviceConfig(this.$route.query.testEqpId)},computed:{tiplist:function(){var t=[];return t="tank"==this.$route.query.controlType?this.stepTestInfo.process[this.testStepId].tankTips:this.stepTestInfo.process[this.testStepId].tips,t}},watch:{testStepId:function(t){var e=this;this.countDownProject&&(clearInterval(this.countDownProject),this.countDownNumber=120),this.dealCountDown(),this.statusItems=[],this.controlItems=[];var o=[],n=[];this.$store.getters.registers.map(function(t){t.type==e.formdata.eqpTpye&&(o=t.formgroup)}),this.stepTestInfo.process[t].testItems&&this.stepTestInfo.process[t].testItems.split(",").map(function(t){o.map(function(e){t==e.key&&n.push(e)})}),n.map(function(t){t.value=e.formdata[t.key],"statusR"!=t.controlType||!t.value&&"0"!=t.value||(t.disabled=!0,e.statusItems.push(t)),"controlR"!=t.controlType||!t.value&&"0"!=t.value||(t.disabled=!0,e.controlItems.push(t))})}},beforeDestroy:function(){var t=this;this.connectedController&&this.$postData(this.$api.closeController,{ctrlId:this.$route.query.eqpId,gatewayId:this.gatewayInfo.hwSysId}).then(function(){t.connectedController=!1}),this.stompClient&&(n["default"].closeSubscribe(this.subscribeArray),n["default"].socketDisconnect(this.stompClient)),this.countDownProject&&clearInterval(this.countDownProject)}},r=function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("div",{staticClass:"manage"},[o("myheader",{attrs:{myheaderOption:t.headerOptionSettings}}),t._v(" "),o("mt-cell",{attrs:{title:"设备名",value:t.formdata.eqpName}}),t._v(" "),o("mt-cell",{attrs:{title:"状态寄存器地址",value:t.formdata.statusRegister}}),t._v(" "),o("mt-cell",{attrs:{title:"控制寄存器地址",value:t.formdata.controlRegister}}),t._v(" "),o("div",{staticClass:"bgfff mt10"},[o("div",{staticClass:"pl15 mb15"},[o("mt-cell",{attrs:{title:t.stepTestInfo.process[t.testStepId].tipsTitle}}),t._v(" "),o("ul",{staticClass:"pl10 text-info"},t._l(t.tiplist,function(e,n){return o("li",{key:n},[t._v("\n          "+t._s(e.tip)+"\n        ")])}),0)],1),t._v(" "),t.stepTestInfo.process[t.testStepId].testItems?o("div",{staticClass:"pl15 mb15"},[o("mt-checklist",{staticClass:"page-part testPageChecklist",attrs:{title:"状态寄存器",options:t.statusItems},model:{value:t.statusvalue,callback:function(e){t.statusvalue=e},expression:"statusvalue"}}),t._v(" "),o("div",{staticClass:"mt5 mb10"},[t._v("\n        已获取到的状态值:\n        "),t._l(t.statusvalue,function(e,n){return o("span",{key:n},[t._v("\n          "+t._s(e)+"\n        ")])})],2),t._v(" "),o("mt-checklist",{staticClass:"page-part testPageChecklist",attrs:{title:"控制寄存器",options:t.controlItems},model:{value:t.controlvalue,callback:function(e){t.controlvalue=e},expression:"controlvalue"}}),t._v(" "),o("div",{staticClass:"mt5 mb10"},[t._v("\n        已获取到的控制值:\n        "),t._l(t.controlvalue,function(e,n){return o("span",{key:n},[t._v("\n          "+t._s(e)+"\n        ")])})],2)],1):t._e(),t._v(" "),o("div",{staticClass:"pb10"},["tank"!=t.$route.query.controlType?o("div",{staticClass:"largeBtnContainer mb10"},[t._l(t.stepTestInfo.process[t.testStepId].operateButtons,function(e){return[o("mt-button",{key:e.instruction,attrs:{size:"large",type:"primary"},nativeOn:{click:function(o){return t.handleOperateEqp(e.instruction)}}},[t._v("\n            "+t._s(e.label)+"\n          ")])]})],2):t._e(),t._v(" "),o("div",{staticClass:"largeBtnContainer mb10 clearfix"},[t._l(t.stepTestInfo.process[t.testStepId].stepButtons,function(e){return[o("div",{key:e.instruction,staticClass:"harfBtnContainer"},[o("mt-button",{attrs:{size:"large",type:"primary"},nativeOn:{click:function(o){return t.handleStep(e)}}},[t._v("\n              "+t._s(e.label)+"\n            ")])],1)]})],2)]),t._v(" "),o("div",{staticClass:"positionFix countDownNumber pt5 pb5 pl10 pr10 borderR10"},[t._v("\n      "+t._s(t.countDownNumber)+" s\n    ")]),t._v(" "),t.showLoadingDiv?o("div",{staticClass:"positionFix loadingGifBg"},[t._m(0)]):t._e()])],1)},a=[function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"positionAbs positionCenter"},[n("div",{staticClass:"mgAuto"},[n("img",{attrs:{src:o("cf1c")}})])])}],i=o("2455"),l=!1,c=null,u=null,p=null,f=Object(i["a"])(s,r,a,l,c,u,p);e["default"]=f.exports},"7f7f":function(t,e,o){var n=o("86cc").f,s=Function.prototype,r=/^\s*function ([^ (]*)/,a="name";a in s||o("9e1e")&&n(s,a,{configurable:!0,get:function(){try{return(""+this).match(r)[1]}catch(t){return""}}})},aae3:function(t,e,o){var n=o("d3f4"),s=o("2d95"),r=o("2b4c")("match");t.exports=function(t){var e;return n(t)&&(void 0!==(e=t[r])?!!e:"RegExp"==s(t))}},b0c5:function(t,e,o){"use strict";var n=o("520a");o("5ca1")({target:"RegExp",proto:!0,forced:n!==/./.exec},{exec:n})},cf1c:function(t,e,o){t.exports=o.p+"img/loading.d44cb140.gif"}}]);